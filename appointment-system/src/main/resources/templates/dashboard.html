<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Patient Dashboard - HABS</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f7f9fc; margin: 0; padding: 0; }
        header { background-color: #0078d7; color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; }
        table { width: 90%; margin: 30px auto; border-collapse: collapse; background-color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #0078d7; color: white; }
        button { background-color: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #218838; }
        #confirmation { display: none; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>

<header>
    <h1>Patient Dashboard</h1>
    <div>
        <p><strong>Name:</strong> <span id="patientName"></span></p>
        <p><strong>ID:</strong> <span id="patientId"></span></p>
    </div>
</header>

<h2 style="text-align:center;">Available Doctors</h2>

<table>
    <thead>
    <tr>
        <th>Select</th>
        <th>Doctor Name</th>
        <th>Specialization</th>
        <th>Clinic</th>
        <th>Address</th>
        <th>Available Time</th>
        <th>Fees</th>
    </tr>
    </thead>
    <tbody id="doctorList"></tbody>
</table>

<div style="text-align:center;">
    <button id="makeAppointmentBtn">Make Appointment</button>
    <button id="logoutBtn">Logout</button>
</div>

<div id="confirmation">
    <h3>✅ Appointment Confirmed!</h3>
    <p>Your token number: <strong id="tokenNumber"></strong></p>
</div>

<script>
    // ✅ Get logged-in user details
    const patientId = localStorage.getItem("userId");
    const patientName = localStorage.getItem("userName");
    const role = localStorage.getItem("role");

    if (!patientId || role !== "patient") {
        alert("Unauthorized access. Please log in as a patient.");
        window.location.href = "/login.html";
    } else {
        document.getElementById("patientName").textContent = patientName;
        document.getElementById("patientId").textContent = patientId;
    }

    // ✅ Fetch doctors dynamically from backend
    async function loadDoctors() {
        try {
            const res = await fetch("/api/appointments/doctors");
            const doctors = await res.json();

            const tbody = document.getElementById("doctorList");
            tbody.innerHTML = "";

            if (!doctors.length) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No doctors registered yet</td></tr>`;
                return;
            }

            doctors.forEach(doc => {
                tbody.innerHTML += `
                    <tr>
                        <td><input type="radio" name="doctor" value="${doc.id}"></td>
                        <td>${doc.name}</td>
                        <td>${doc.specialization}</td>
                        <td>${doc.clinicName || '-'}</td>
                        <td>${doc.address || '-'}</td>
                        <td>${doc.availableTime || '-'}</td>
                        <td>₹${doc.fees || '-'}</td>
                    </tr>`;
            });
        } catch (err) {
            console.error("Failed to load doctors:", err);
        }
    }

    loadDoctors();

    // ✅ Make Appointment dynamically
    document.getElementById("makeAppointmentBtn").addEventListener("click", async () => {
        const selectedDoctor = document.querySelector("input[name='doctor']:checked");
        if (!selectedDoctor) {
            alert("Please select a doctor to book an appointment.");
            return;
        }

        const doctorId = selectedDoctor.value;

        try {
            const res = await fetch(`/api/appointments/book?doctorId=${doctorId}&patientId=${patientId}`, {
                method: "POST"
            });

            const data = await res.json();

            if (res.ok) {
                console.log("Appointment Success:", data);
                document.getElementById("confirmation").style.display = "block";
                setTimeout(() => {
                    document.getElementById("confirmation").style.display = "none";
                }, 3000);
            } else {
                alert(data.message || "Failed to book appointment. Please try again.");
            }
        } catch (err) {
            console.error("Error booking appointment:", err);
            alert("Something went wrong. Try again later.");
        }
    });

    // ✅ Logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.clear();
        window.location.href = "/login.html";
    });
</script>

</body>
</html>
